# .github/workflows/backup-scheduler.yml
# ì¼ì¼ ìžë™ ë°±ì—… ìŠ¤ì¼€ì¤„ëŸ¬
# **Requirements: 1.1.1**

name: Daily Backup Scheduler

on:
  schedule:
    # ë§¤ì¼ ìƒˆë²½ 3ì‹œ (KST) = UTC 18:00 (ì „ë‚ )
    - cron: '0 18 * * *'
  workflow_dispatch:
    inputs:
      cleanup_only:
        description: 'ì •ë¦¬ë§Œ ì‹¤í–‰ (ë°±ì—… ìƒì„± ê±´ë„ˆë›°ê¸°)'
        required: false
        default: 'false'
        type: boolean

env:
  API_BASE_URL: ${{ secrets.API_BASE_URL }}
  BACKUP_API_KEY: ${{ secrets.BACKUP_API_KEY }}

jobs:
  backup:
    name: Create Daily Backup
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.cleanup_only != 'true' }}
    
    steps:
      - name: Create Backup
        id: backup
        run: |
          echo "Creating daily backup..."
          
          RESPONSE=$(curl -s -w "\n%{http_code}" \
            -X POST \
            -H "Content-Type: application/json" \
            -H "x-api-key: $BACKUP_API_KEY" \
            "$API_BASE_URL/api/admin/backups/scheduled")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          echo "HTTP Status: $HTTP_CODE"
          echo "Response: $BODY"
          
          if [ "$HTTP_CODE" -ne 200 ]; then
            echo "::error::Backup creation failed with status $HTTP_CODE"
            exit 1
          fi
          
          echo "backup_result=$BODY" >> $GITHUB_OUTPUT
          echo "âœ… Backup created successfully"

      - name: Notify Success
        if: success()
        run: |
          echo "ðŸ“¦ Daily backup completed successfully"
          echo "Result: ${{ steps.backup.outputs.backup_result }}"

      - name: Notify Failure
        if: failure()
        run: |
          echo "âŒ Daily backup failed"
          # ì—¬ê¸°ì— Slack/Discord ì•Œë¦¼ ì¶”ê°€ ê°€ëŠ¥

  cleanup:
    name: Cleanup Old Backups
    runs-on: ubuntu-latest
    needs: [backup]
    if: always()
    
    steps:
      - name: Cleanup Old Backups
        id: cleanup
        run: |
          echo "Cleaning up backups older than 7 days..."
          
          RESPONSE=$(curl -s -w "\n%{http_code}" \
            -X POST \
            -H "Content-Type: application/json" \
            -H "x-api-key: $BACKUP_API_KEY" \
            "$API_BASE_URL/api/admin/backups/cleanup?retentionDays=7")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          echo "HTTP Status: $HTTP_CODE"
          echo "Response: $BODY"
          
          if [ "$HTTP_CODE" -ne 200 ]; then
            echo "::warning::Backup cleanup failed with status $HTTP_CODE"
            # ì •ë¦¬ ì‹¤íŒ¨ëŠ” ê²½ê³ ë§Œ í‘œì‹œ (ì „ì²´ ì›Œí¬í”Œë¡œìš° ì‹¤íŒ¨ë¡œ ì²˜ë¦¬í•˜ì§€ ì•ŠìŒ)
          else
            echo "âœ… Cleanup completed successfully"
          fi
          
          echo "cleanup_result=$BODY" >> $GITHUB_OUTPUT

      - name: Check Backup Status
        run: |
          echo "Checking backup status..."
          
          RESPONSE=$(curl -s \
            -H "x-api-key: $BACKUP_API_KEY" \
            "$API_BASE_URL/api/admin/backups/status")
          
          echo "Backup Status: $RESPONSE"

  notify:
    name: Send Notification
    runs-on: ubuntu-latest
    needs: [backup, cleanup]
    if: always()
    
    steps:
      - name: Summary
        run: |
          echo "## Daily Backup Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Date**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "- **Backup Job**: ${{ needs.backup.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Cleanup Job**: ${{ needs.cleanup.result }}" >> $GITHUB_STEP_SUMMARY
