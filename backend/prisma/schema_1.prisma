// prisma/schema.prisma
// CHEMON 견적관리 시스템 - 확장 스키마
// 리드 관리, 계약 관리, 시험 관리, 상담기록 추가

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== Enums ====================

enum UserRole {
  USER
  ADMIN
}

enum UserStatus {
  ACTIVE
  INACTIVE
  LOCKED
}

enum QuotationStatus {
  DRAFT
  SENT
  ACCEPTED
  REJECTED
  EXPIRED
}

enum QuotationType {
  TOXICITY
  EFFICACY
}

enum AnnouncementPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

enum NotificationType {
  ANNOUNCEMENT
  SYSTEM
  REMINDER
}

// 신규 Enum - 리드 관련
enum LeadSource {
  EMAIL
  PHONE
  WEBSITE
  REFERRAL
  EXHIBITION
  OTHER
}

enum LeadStatus {
  NEW           // 신규
  CONTACTED     // 연락완료
  QUALIFIED     // 검토완료
  PROPOSAL      // 견적발송 (잠재고객)
  NEGOTIATION   // 협상중
  CONVERTED     // 계약전환 (고객)
  LOST          // 실패
  DORMANT       // 휴면
}

// 신규 Enum - 계약 관련
enum ContractStatus {
  NEGOTIATING   // 협의중
  SIGNED        // 체결
  TEST_RECEIVED // 시험접수
  IN_PROGRESS   // 진행중
  COMPLETED     // 완료
  TERMINATED    // 해지
}

// 신규 Enum - 시험 관련
enum StudyStatus {
  REGISTERED    // 접수
  PREPARING     // 준비중
  IN_PROGRESS   // 진행중
  ANALYSIS      // 분석중
  REPORT_DRAFT  // 보고서 작성중
  REPORT_REVIEW // 보고서 검토중
  COMPLETED     // 완료
  SUSPENDED     // 중단
}

// 신규 Enum - 고객 등급
enum CustomerGrade {
  LEAD          // 리드 (문의단계)
  PROSPECT      // 잠재고객 (견적발송)
  CUSTOMER      // 고객 (계약체결)
  VIP           // VIP 고객
  INACTIVE      // 비활성
}

// ==================== User & Auth ====================

model User {
  id            String       @id @default(uuid())
  email         String       @unique
  password      String
  name          String
  phone         String?
  department    String?
  position      String?
  role          UserRole     @default(USER)
  status        UserStatus   @default(ACTIVE)
  loginAttempts Int          @default(0)
  lockedUntil   DateTime?
  lastLoginAt   DateTime?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  // 기존 관계
  quotations    Quotation[]
  customers     Customer[]
  notifications Notification[]
  activityLogs  ActivityLog[]
  announcements Announcement[] @relation("CreatedAnnouncements")
  refreshTokens RefreshToken[]
  
  // 신규 관계
  leads               Lead[]
  leadActivities      LeadActivity[]
  contracts           Contract[]
  consultationRecords ConsultationRecord[]
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())
}

// ==================== Pipeline & Workflow (신규) ====================

// 파이프라인 단계 (사용자 정의 가능)
model PipelineStage {
  id          String   @id @default(uuid())
  name        String                         // 단계명 (문의접수, 검토 등)
  code        String   @unique               // 코드 (INQUIRY, REVIEW 등)
  order       Int                            // 순서
  color       String?                        // UI 표시 색상
  description String?                        // 설명
  isDefault   Boolean  @default(false)       // 기본 단계 여부
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  leads Lead[]
  tasks StageTask[]
}

// 단계별 세부 태스크 (사용자 정의 가능)
model StageTask {
  id          String        @id @default(uuid())
  stageId     String
  stage       PipelineStage @relation(fields: [stageId], references: [id], onDelete: Cascade)
  name        String                         // 태스크명
  order       Int                            // 순서
  isRequired  Boolean       @default(false)  // 필수 여부
  description String?
  isActive    Boolean       @default(true)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  completions LeadTaskCompletion[]
}

// ==================== Lead Management (신규) ====================

model Lead {
  id             String        @id @default(uuid())
  leadNumber     String        @unique              // LD-2025-0001
  
  // 담당자
  userId         String
  user           User          @relation(fields: [userId], references: [id])
  
  // 고객사 정보 (Customer 전환 전)
  companyName    String                             // 회사명
  contactName    String                             // 담당자명
  contactEmail   String?
  contactPhone   String?
  department     String?                            // 부서
  position       String?                            // 직책
  
  // 문의 정보
  source         LeadSource    @default(OTHER)      // 유입 경로
  inquiryType    QuotationType?                     // 독성/효력
  inquiryDetail  String?                            // 문의 내용
  expectedAmount Decimal?      @db.Decimal(15, 2)   // 예상 금액
  expectedDate   DateTime?                          // 예상 계약일
  
  // 파이프라인
  stageId        String
  stage          PipelineStage @relation(fields: [stageId], references: [id])
  status         LeadStatus    @default(NEW)
  
  // 전환 정보
  customerId     String?                            // 전환된 Customer ID
  customer       Customer?     @relation(fields: [customerId], references: [id])
  convertedAt    DateTime?
  lostReason     String?                            // 실패 사유
  
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  deletedAt      DateTime?

  activities      LeadActivity[]
  taskCompletions LeadTaskCompletion[]
  quotations      Quotation[]
}

// 리드 활동 기록 (상담 내역)
model LeadActivity {
  id          String   @id @default(uuid())
  leadId      String
  lead        Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  
  type        String                           // CALL, EMAIL, MEETING, NOTE
  subject     String                           // 제목
  content     String                           // 내용
  contactedAt DateTime @default(now())         // 연락 일시
  nextAction  String?                          // 다음 액션
  nextDate    DateTime?                        // 다음 일정
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// 리드별 태스크 완료 현황
model LeadTaskCompletion {
  id          String    @id @default(uuid())
  leadId      String
  lead        Lead      @relation(fields: [leadId], references: [id], onDelete: Cascade)
  taskId      String
  task        StageTask @relation(fields: [taskId], references: [id], onDelete: Cascade)
  completedBy String
  completedAt DateTime  @default(now())
  notes       String?

  @@unique([leadId, taskId])
}

// ==================== Customer (확장) ====================

model Customer {
  id        String        @id @default(uuid())
  userId    String
  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  name      String
  company   String?
  email     String?
  phone     String?
  address   String?
  notes     String?
  grade     CustomerGrade @default(PROSPECT)    // 신규: 고객 등급
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  deletedAt DateTime?

  // 기존 관계
  quotations Quotation[]
  
  // 신규 관계
  leads               Lead[]
  contracts           Contract[]
  consultationRecords ConsultationRecord[]
}

// ==================== Quotation (확장) ====================

model Quotation {
  id               String          @id @default(uuid())
  quotationNumber  String          @unique
  quotationType    QuotationType   @default(TOXICITY)
  userId           String
  user             User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  customerId       String?
  customer         Customer?       @relation(fields: [customerId], references: [id])
  customerName     String
  projectName      String
  modality         String?
  
  // 효력시험 전용 필드
  modelId          String?
  modelCategory    String?
  indication       String?
  
  items            Json
  
  // 금액 정보
  subtotalTest     Decimal?        @db.Decimal(15, 2)
  subtotalAnalysis Decimal?        @db.Decimal(15, 2)
  subtotal         Decimal?        @db.Decimal(15, 2)
  discountRate     Decimal?        @db.Decimal(5, 2)
  discountAmount   Decimal?        @db.Decimal(15, 2)
  vat              Decimal?        @db.Decimal(15, 2)
  totalAmount      Decimal         @db.Decimal(15, 2)
  
  validDays        Int             @default(30)
  validUntil       DateTime?
  notes            String?
  status           QuotationStatus @default(DRAFT)
  
  // 신규: 버전 관리
  version          Int             @default(1)          // 버전 번호
  parentId         String?                              // 원본 견적서 ID
  parent           Quotation?      @relation("QuotationVersions", fields: [parentId], references: [id])
  revisions        Quotation[]     @relation("QuotationVersions")
  
  // 신규: 리드 연결
  leadId           String?
  lead             Lead?           @relation(fields: [leadId], references: [id])
  
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  deletedAt        DateTime?

  // 신규: 계약 연결
  contracts        Contract[]      @relation("QuotationContracts")
}

// ==================== Contract (신규) ====================

model Contract {
  id             String         @id @default(uuid())
  contractNumber String         @unique              // CT-2025-0001
  
  // 관계
  userId         String
  user           User           @relation(fields: [userId], references: [id])
  customerId     String
  customer       Customer       @relation(fields: [customerId], references: [id])
  
  // 계약 정보
  title          String                              // 계약명
  contractType   QuotationType                       // 독성/효력
  
  // 금액
  totalAmount    Decimal        @db.Decimal(15, 2)
  paidAmount     Decimal        @default(0) @db.Decimal(15, 2)
  
  // 일정
  signedDate     DateTime?                           // 계약 체결일
  startDate      DateTime?                           // 계약 시작일
  endDate        DateTime?                           // 계약 종료일
  
  // 상태
  status         ContractStatus @default(NEGOTIATING)
  
  // 내용
  terms          String?                             // 계약 조건
  notes          String?
  
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  deletedAt      DateTime?

  // 관계
  quotations    Quotation[]           @relation("QuotationContracts")
  amendments    ContractAmendment[]
  studies       Study[]
  consultations ConsultationRecord[]
}

// 변경계약서 (신규)
model ContractAmendment {
  id              String   @id @default(uuid())
  amendmentNumber String   @unique                    // CT-2025-0001-A1
  contractId      String
  contract        Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)
  
  version         Int                                 // 변경 차수
  reason          String                              // 변경 사유
  changes         Json                                // 변경 내용 (이전값, 변경값)
  
  // 금액 변경
  amountChange    Decimal? @db.Decimal(15, 2)         // 금액 증감
  newTotalAmount  Decimal  @db.Decimal(15, 2)         // 변경 후 총액
  
  // 일정 변경
  newEndDate      DateTime?
  
  signedDate      DateTime?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// ==================== Study (신규) ====================

model Study {
  id              String      @id @default(uuid())
  studyNumber     String      @unique                 // ST-2025-0001
  contractId      String
  contract        Contract    @relation(fields: [contractId], references: [id])
  
  // 시험 정보
  studyType       QuotationType
  testName        String                              // 시험명
  testItemId      String?                             // ToxicityTest 또는 EfficacyModel ID
  
  // 일정
  receivedDate    DateTime?                           // 시험접수일
  startDate       DateTime?                           // 시험시작일
  expectedEndDate DateTime?                           // 예상종료일
  actualEndDate   DateTime?                           // 실제종료일
  
  // 상태
  status          StudyStatus @default(REGISTERED)
  
  // 보고서
  reportDraftDate DateTime?                           // 초안 완료일
  reportFinalDate DateTime?                           // 최종 발행일
  
  notes           String?
  
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
}

// ==================== Consultation Record (신규) ====================

model ConsultationRecord {
  id              String    @id @default(uuid())
  recordNumber    String    @unique                   // CR-2025-0001
  
  contractId      String?
  contract        Contract? @relation(fields: [contractId], references: [id])
  customerId      String
  customer        Customer  @relation(fields: [customerId], references: [id])
  userId          String
  user            User      @relation(fields: [userId], references: [id])
  
  // 고객사 정보 (스냅샷)
  customerInfo    Json                                // 고객사 상세 정보
  
  // 시험 정보
  testInfo        Json?                               // 계약된 시험 정보
  
  // 물질 정보
  substanceInfo   Json?                               // 물질 정보
  substanceName   String?                             // 물질명
  storageStatus   String?                             // 보관 여부/상태
  storageLocation String?                             // 보관 위치
  
  // 요청사항
  clientRequests  String?                             // 의뢰자 요청사항
  internalNotes   String?                             // 내부 메모
  
  consultDate     DateTime  @default(now())           // 상담일
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  deletedAt       DateTime?
}

// ==================== Notification & Activity (기존 유지) ====================

model Announcement {
  id        String               @id @default(uuid())
  title     String
  content   String
  priority  AnnouncementPriority @default(NORMAL)
  startDate DateTime
  endDate   DateTime
  isActive  Boolean              @default(true)
  viewCount Int                  @default(0)
  createdBy String
  creator   User                 @relation("CreatedAnnouncements", fields: [createdBy], references: [id])
  createdAt DateTime             @default(now())
  updatedAt DateTime             @updatedAt
  deletedAt DateTime?

  views AnnouncementView[]
}

model AnnouncementView {
  id             String       @id @default(uuid())
  announcementId String
  announcement   Announcement @relation(fields: [announcementId], references: [id], onDelete: Cascade)
  userId         String
  viewedAt       DateTime     @default(now())

  @@unique([announcementId, userId])
}

model Notification {
  id        String           @id @default(uuid())
  userId    String
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  type      NotificationType
  title     String
  message   String
  isRead    Boolean          @default(false)
  link      String?
  createdAt DateTime         @default(now())
}

model ActivityLog {
  id         String   @id @default(uuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  action     String
  resource   String
  resourceId String?
  details    Json?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())
}

// ==================== System Settings (기존 유지) ====================

model SystemSetting {
  id        String   @id @default(uuid())
  key       String   @unique
  value     String
  updatedAt DateTime @updatedAt
}

model SettingHistory {
  id        String   @id @default(uuid())
  key       String
  oldValue  String?
  newValue  String
  changedBy String
  changedAt DateTime @default(now())
}

model Backup {
  id        String   @id @default(uuid())
  filename  String
  size      BigInt
  status    String   @default("COMPLETED")
  type      String   @default("AUTO")
  createdAt DateTime @default(now())
}

// ==================== Master Data - Toxicity (기존 유지) ====================

model ToxicityTest {
  id                    String   @id @default(uuid())
  itemId                Int      @unique
  sheet                 String
  category              String
  subcategory           String
  testName              String?
  oecd                  String?
  testType              String?
  animalClass           String?
  species               String?
  sexConfig             String?
  animalsPerSex         Int?
  controlGroups         Int?
  testGroups            Int?
  totalGroups           Int?
  routeGroup            String?
  routes                String?
  duration              String?
  leadTime              String?
  price                 Decimal? @db.Decimal(15, 2)
  samplingPointsTest    Int?
  samplingPointsControl Int?
  samplingCount         Int?
  samplingDays          String?
  totalSamplingPoints   Int?
  priceWithAnalysis     Decimal? @db.Decimal(15, 2)
  priceSamplingOnly     String?
  optionNote            String?
  remarks               String?
  isActive              Boolean  @default(true)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
}

model ToxicityCategory {
  id          String   @id @default(uuid())
  categoryId  Int      @unique
  sheet       String
  category    String
  subcategory String
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model AnimalClass {
  id        String   @id @default(uuid())
  classId   Int      @unique
  name      String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Species {
  id        String   @id @default(uuid())
  speciesId Int      @unique
  name      String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Route {
  id        String   @id @default(uuid())
  routeId   Int      @unique
  name      String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ==================== Master Data - Efficacy (기존 유지) ====================

model EfficacyPriceItem {
  id          String   @id @default(uuid())
  itemId      String   @unique
  category    String
  subcategory String?
  itemName    String
  itemDetail  String?
  unitPrice   Decimal  @db.Decimal(15, 2)
  unit        String?
  remarks     String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model EfficacyModel {
  id              String   @id @default(uuid())
  modelId         String   @unique
  modelName       String
  category        String
  indication      String?
  animalType      String?
  inductionMethod String?
  duration        String?
  description     String?
  defaultItems    Json?
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model Modality {
  id          String   @id @default(uuid())
  code        String   @unique
  name        String
  level       Int      @default(1)
  parentCode  String?
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}
