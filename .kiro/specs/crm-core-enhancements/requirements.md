# CRM 핵심 기능 강화 - 요구사항

## 개요
CHEMON CRM 시스템의 핵심 부족 기능 3가지를 구현합니다:
1. 자동 백업 시스템 (데이터 안전성)
2. 자동화 규칙 엔진 (워크플로우 자동화)
3. 모바일 PWA 지원 (모바일 대응)

---

## Feature 1: 자동 백업 시스템

### 1.1 일일 자동 백업
**As a** 시스템 관리자
**I want** 매일 자동으로 데이터베이스가 백업되기를
**So that** 데이터 손실 시 복구할 수 있습니다

**Acceptance Criteria:**
- [ ] 1.1.1 매일 지정된 시간(새벽 3시)에 자동 백업 실행
- [ ] 1.1.2 백업 파일은 JSON 형식으로 주요 테이블 데이터 포함
- [ ] 1.1.3 백업 완료/실패 시 관리자에게 알림 발송
- [ ] 1.1.4 최근 7일간의 백업 파일 유지 (이전 파일 자동 삭제)

### 1.2 수동 백업 기능
**As a** 관리자
**I want** 언제든지 수동으로 백업을 생성할 수 있기를
**So that** 중요한 변경 전에 데이터를 보호할 수 있습니다

**Acceptance Criteria:**
- [ ] 1.2.1 관리자 페이지에서 "지금 백업" 버튼 제공
- [ ] 1.2.2 백업 진행 상태 표시 (진행률 또는 스피너)
- [ ] 1.2.3 백업 완료 후 다운로드 링크 제공
- [ ] 1.2.4 백업 히스토리 목록 표시 (날짜, 크기, 상태)

### 1.3 데이터 복구 기능
**As a** 관리자
**I want** 백업 파일에서 데이터를 복구할 수 있기를
**So that** 데이터 손실 시 빠르게 복구할 수 있습니다

**Acceptance Criteria:**
- [ ] 1.3.1 백업 파일 선택하여 복구 시작 가능
- [ ] 1.3.2 복구 전 확인 다이얼로그 표시 (경고 메시지 포함)
- [ ] 1.3.3 테이블별 선택적 복구 옵션 제공
- [ ] 1.3.4 복구 완료 후 결과 리포트 표시

### 1.4 백업 데이터 범위
**As a** 시스템
**I want** 핵심 비즈니스 데이터만 백업하기를
**So that** 백업 파일 크기를 최적화할 수 있습니다

**Acceptance Criteria:**
- [ ] 1.4.1 User, Customer, Lead, Quotation, Contract, Study 테이블 백업
- [ ] 1.4.2 시스템 설정(SystemSetting) 백업
- [ ] 1.4.3 파이프라인 단계(PipelineStage, StageTask) 백업
- [ ] 1.4.4 마스터 데이터는 제외 (ToxicityTest, EfficacyModel 등)

---

## Feature 2: 자동화 규칙 엔진

### 2.1 자동화 규칙 생성
**As a** 관리자
**I want** 트리거 기반 자동화 규칙을 생성할 수 있기를
**So that** 반복 작업을 자동화할 수 있습니다

**Acceptance Criteria:**
- [ ] 2.1.1 규칙 이름, 설명, 활성화 상태 설정
- [ ] 2.1.2 트리거 유형 선택 (상태 변경, 날짜 도달, 항목 생성)
- [ ] 2.1.3 조건 설정 (예: 견적 금액 > 1억)
- [ ] 2.1.4 액션 설정 (알림 발송, 상태 변경, 담당자 배정)

### 2.2 상태 변경 트리거
**As a** 영업 담당자
**I want** 리드 상태가 변경될 때 자동으로 알림을 받기를
**So that** 중요한 진행 상황을 놓치지 않습니다

**Acceptance Criteria:**
- [ ] 2.2.1 리드 상태 변경 시 트리거 발동
- [ ] 2.2.2 견적서 상태 변경 시 트리거 발동
- [ ] 2.2.3 계약 상태 변경 시 트리거 발동
- [ ] 2.2.4 특정 상태로 변경 시에만 발동하도록 조건 설정 가능

### 2.3 날짜 기반 트리거
**As a** 영업 담당자
**I want** 견적 만료 3일 전에 자동 알림을 받기를
**So that** 팔로업을 놓치지 않습니다

**Acceptance Criteria:**
- [ ] 2.3.1 견적 만료일 N일 전 알림 트리거
- [ ] 2.3.2 계약 종료일 N일 전 알림 트리거
- [ ] 2.3.3 리드 생성 후 N일 동안 활동 없으면 알림 트리거
- [ ] 2.3.4 매일 스케줄러가 날짜 조건 체크

### 2.4 자동 액션 실행
**As a** 시스템
**I want** 트리거 발동 시 설정된 액션을 자동 실행하기를
**So that** 사용자 개입 없이 작업이 처리됩니다

**Acceptance Criteria:**
- [ ] 2.4.1 인앱 알림 발송 액션
- [ ] 2.4.2 상태 자동 변경 액션 (예: 만료일 지나면 EXPIRED로)
- [ ] 2.4.3 활동 기록 자동 생성 액션
- [ ] 2.4.4 액션 실행 로그 기록

### 2.5 자동화 규칙 관리
**As a** 관리자
**I want** 자동화 규칙을 관리할 수 있기를
**So that** 규칙을 수정하거나 비활성화할 수 있습니다

**Acceptance Criteria:**
- [ ] 2.5.1 규칙 목록 조회 (이름, 트리거, 상태, 실행 횟수)
- [ ] 2.5.2 규칙 활성화/비활성화 토글
- [ ] 2.5.3 규칙 수정 및 삭제
- [ ] 2.5.4 규칙 실행 히스토리 조회

---

## Feature 3: 모바일 PWA 지원

### 3.1 PWA 기본 설정
**As a** 사용자
**I want** 앱을 홈 화면에 설치할 수 있기를
**So that** 네이티브 앱처럼 빠르게 접근할 수 있습니다

**Acceptance Criteria:**
- [ ] 3.1.1 manifest.json 파일 생성 (앱 이름, 아이콘, 테마 색상)
- [ ] 3.1.2 Service Worker 등록
- [ ] 3.1.3 "홈 화면에 추가" 프롬프트 표시
- [ ] 3.1.4 스플래시 스크린 설정

### 3.2 오프라인 지원
**As a** 영업 담당자
**I want** 인터넷 연결이 불안정해도 앱을 사용할 수 있기를
**So that** 외근 중에도 데이터를 확인할 수 있습니다

**Acceptance Criteria:**
- [ ] 3.2.1 정적 자산(JS, CSS, 이미지) 캐싱
- [ ] 3.2.2 최근 조회한 데이터 로컬 캐싱
- [ ] 3.2.3 오프라인 상태 표시 배너
- [ ] 3.2.4 온라인 복귀 시 자동 동기화

### 3.3 모바일 최적화 UI
**As a** 모바일 사용자
**I want** 터치에 최적화된 UI를 사용하기를
**So that** 작은 화면에서도 편하게 사용할 수 있습니다

**Acceptance Criteria:**
- [ ] 3.3.1 터치 타겟 최소 44px 보장
- [ ] 3.3.2 스와이프 제스처 지원 (리드 카드 스와이프로 상태 변경)
- [ ] 3.3.3 하단 네비게이션 바 (모바일 전용)
- [ ] 3.3.4 풀투리프레시 지원

### 3.4 푸시 알림
**As a** 사용자
**I want** 중요한 알림을 푸시로 받기를
**So that** 앱을 열지 않아도 알림을 확인할 수 있습니다

**Acceptance Criteria:**
- [ ] 3.4.1 푸시 알림 권한 요청
- [ ] 3.4.2 새 리드 등록 시 푸시 알림
- [ ] 3.4.3 견적 상태 변경 시 푸시 알림
- [ ] 3.4.4 알림 클릭 시 해당 페이지로 이동

### 3.5 모바일 전용 기능
**As a** 외근 중인 영업 담당자
**I want** 모바일에서 빠르게 리드를 등록할 수 있기를
**So that** 현장에서 바로 정보를 입력할 수 있습니다

**Acceptance Criteria:**
- [ ] 3.5.1 간소화된 리드 등록 폼 (필수 필드만)
- [ ] 3.5.2 전화번호 클릭 시 바로 전화 연결
- [ ] 3.5.3 이메일 클릭 시 메일 앱 연동
- [ ] 3.5.4 카메라로 명함 촬영 후 OCR (향후 확장)

---

## 기술 요구사항

### 백엔드
- Node.js 스케줄러 (node-cron) 사용
- 백업 파일 저장소: 로컬 또는 S3 호환 스토리지
- 자동화 엔진: 이벤트 기반 아키텍처

### 프론트엔드
- Next.js PWA 플러그인 (next-pwa)
- Service Worker: Workbox
- 푸시 알림: Web Push API

### 인프라
- Render 무료 티어 제약 고려 (백그라운드 작업 제한)
- 대안: Render Cron Jobs 또는 외부 스케줄러 (GitHub Actions)

---

## 우선순위

| 기능 | 우선순위 | 예상 소요 |
|------|----------|-----------|
| 1.2 수동 백업 | P0 | 4시간 |
| 1.4 백업 데이터 범위 | P0 | 2시간 |
| 2.1 자동화 규칙 생성 | P1 | 8시간 |
| 2.2 상태 변경 트리거 | P1 | 4시간 |
| 3.1 PWA 기본 설정 | P1 | 4시간 |
| 3.3 모바일 최적화 UI | P1 | 6시간 |
| 1.1 일일 자동 백업 | P2 | 4시간 |
| 2.3 날짜 기반 트리거 | P2 | 6시간 |
| 3.2 오프라인 지원 | P2 | 8시간 |
| 3.4 푸시 알림 | P2 | 6시간 |

---

## 제약사항

1. Render 무료 티어는 백그라운드 작업 지원 제한
2. 푸시 알림은 HTTPS 필수
3. 백업 파일 크기 제한 (무료 스토리지 용량)
4. Service Worker는 localhost 또는 HTTPS에서만 동작
